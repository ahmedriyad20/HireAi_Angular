<!-- Loading State -->
@if (isLoading()) {
  <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading jobs...</p>
    </div>
  </div>
}

<!-- Error State -->
@else if (error()) {
  <div class="alert alert-danger d-flex align-items-center gap-3" role="alert">
    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
    <div class="flex-grow-1">
      <strong>Error:</strong> {{ error() }}
    </div>
    <button class="btn btn-sm btn-outline-danger" (click)="retryLoad()">
      <i class="bi bi-arrow-clockwise me-1"></i>
      Retry
    </button>
  </div>
}

<!-- Main Content -->
@else {
  <div class="hr-jobs-page">
    <!-- Page Header -->
    <div class="page-header mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h1 class="page-title mb-1">Job Postings</h1>
          <p class="page-subtitle mb-0">Manage your job openings and track applications</p>
        </div>
        <button class="btn btn-primary" routerLink="/hr/jobs/create">
          <i class="bi bi-plus-circle me-2"></i>
          Post New Job
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon-wrapper bg-primary-subtle">
            <i class="bi bi-briefcase-fill text-primary"></i>
          </div>
          <div>
            <div class="stat-value">{{ stats().total }}</div>
            <div class="stat-label">Total Jobs</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon-wrapper bg-success-subtle">
            <i class="bi bi-check-circle-fill text-success"></i>
          </div>
          <div>
            <div class="stat-value">{{ stats().active }}</div>
            <div class="stat-label">Active Jobs</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon-wrapper bg-secondary-subtle">
            <i class="bi bi-x-circle-fill text-secondary"></i>
          </div>
          <div>
            <div class="stat-value">{{ stats().closed }}</div>
            <div class="stat-label">Closed Jobs</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon-wrapper bg-info-subtle">
            <i class="bi bi-people-fill text-info"></i>
          </div>
          <div>
            <div class="stat-value">{{ stats().totalApplications }}</div>
            <div class="stat-label">Total Applications</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <!-- Search -->
          <div class="col-lg-4">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-search"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                placeholder="Search jobs, company, location..."
                [(ngModel)]="searchQuery"
                (ngModelChange)="searchQuery.set($event)">
            </div>
          </div>

          <!-- Status Filter -->
          <div class="col-lg-2 col-md-4">
            <select 
              class="form-select" 
              [(ngModel)]="selectedStatus"
              (ngModelChange)="selectedStatus.set($event)">
              <option value="all">All Status</option>
              <option value="Active">Active</option>
              <option value="Closed">Closed</option>
              <option value="NotSet">Not Set</option>
            </select>
          </div>

          <!-- Experience Filter -->
          <div class="col-lg-2 col-md-4">
            <select 
              class="form-select"
              [(ngModel)]="selectedExperience"
              (ngModelChange)="selectedExperience.set($event)">
              <option value="all">All Experience</option>
              <option value="EntryLevel">Entry Level</option>
              <option value="Junior">Junior</option>
              <option value="MidLevel">Mid Level</option>
              <option value="Senior">Senior</option>
              <option value="TeamLead">Team Lead</option>
              <option value="Executive">Executive</option>
            </select>
          </div>

          <!-- Employment Type Filter -->
          <div class="col-lg-2 col-md-4">
            <select 
              class="form-select"
              [(ngModel)]="selectedEmploymentType"
              (ngModelChange)="selectedEmploymentType.set($event)">
              <option value="all">All Types</option>
              <option value="FullTime">Full Time</option>
              <option value="PartTime">Part Time</option>
              <option value="Internship">Internship</option>
              <option value="FreeLance">Freelance</option>
            </select>
          </div>

          <!-- View Toggle & Clear -->
          <div class="col-lg-2 col-md-12">
            <div class="d-flex gap-2">
              <div class="btn-group flex-grow-1" role="group">
                <button 
                  type="button" 
                  class="btn btn-outline-secondary"
                  [class.active]="viewMode() === 'grid'"
                  (click)="setViewMode('grid')">
                  <i class="bi bi-grid-3x3-gap-fill"></i>
                </button>
                <button 
                  type="button" 
                  class="btn btn-outline-secondary"
                  [class.active]="viewMode() === 'list'"
                  (click)="setViewMode('list')">
                  <i class="bi bi-list-ul"></i>
                </button>
              </div>
              <button class="btn btn-outline-secondary" (click)="clearFilters()" title="Clear Filters">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Count -->
    <div class="mb-3">
      <p class="text-muted mb-0">
        <strong>{{ filteredJobs().length }}</strong> 
        {{ filteredJobs().length === 1 ? 'job' : 'jobs' }} found
      </p>
    </div>

    <!-- Jobs Grid View -->
    @if (viewMode() === 'grid') {
      @if (filteredJobs().length > 0) {
        <div class="row g-4">
          @for (job of filteredJobs(); track job.id) {
            <div class="col-lg-4 col-md-6">
              <div class="job-card">
                <!-- Card Header -->
                <div class="job-card-header">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="company-logo">
                      <i class="bi bi-building"></i>
                    </div>
                    <span class="badge" [ngClass]="getStatusBadgeClass(job.jobStatus)">
                      {{ job.jobStatus }}
                    </span>
                  </div>
                  <h5 class="job-title">{{ job.title }}</h5>
                  <p class="company-name">
                    <i class="bi bi-building me-1"></i>
                    {{ job.companyName }}
                  </p>
                </div>

                <!-- Card Body -->
                <div class="job-card-body">
                  <p class="job-description">{{ job.description }}</p>

                  <div class="job-meta">
                    @if (job.location) {
                      <div class="meta-item">
                        <i class="bi bi-geo-alt"></i>
                        <span>{{ job.location }}</span>
                      </div>
                    }
                    @if (job.experienceLevel) {
                      <div class="meta-item">
                        <i class="bi bi-award"></i>
                        <span>{{ formatExperienceLevel(job.experienceLevel) }}</span>
                      </div>
                    }
                    @if (job.employmentType) {
                      <div class="meta-item">
                        <i class="bi" [ngClass]="getEmploymentTypeIcon(job.employmentType)"></i>
                        <span>{{ formatEmploymentType(job.employmentType) }}</span>
                      </div>
                    }
                    @if (job.salaryRange) {
                      <div class="meta-item">
                        <i class="bi bi-cash-stack"></i>
                        <span>{{ job.salaryRange }}</span>
                      </div>
                    }
                  </div>

                  <!-- Skills -->
                  @if (job.skills && job.skills.length > 0) {
                    <div class="skills-container mt-3">
                      @for (skill of job.skills.slice(0, 3); track skill.id) {
                        <span class="skill-badge">{{ skill.title }}</span>
                      }
                      @if (job.skills.length > 3) {
                        <span class="skill-badge-more">+{{ job.skills.length - 3 }} more</span>
                      }
                    </div>
                  }
                </div>

                <!-- Card Footer -->
                <div class="job-card-footer">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="footer-stat">
                      <i class="bi bi-people text-primary"></i>
                      <span>{{ job.totalApplications || 0 }} Applications</span>
                    </div>
                    <div class="footer-stat">
                      <i class="bi bi-clipboard-check text-success"></i>
                      <span>{{ job.examsCompleted || 0 }} Exams</span>
                    </div>
                  </div>

                  @if (job.applicationDeadline) {
                    <div class="deadline-info mb-2"
                         [class.text-danger]="isDeadlinePassed(job.applicationDeadline)"
                         [class.text-warning]="isDeadlineSoon(job.applicationDeadline)">
                      <i class="bi bi-calendar-event me-1"></i>
                      <small>Deadline: {{ formatDate(job.applicationDeadline) }}</small>
                    </div>
                  }

                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary flex-grow-1" [routerLink]="['/hr/jobs', job.id]">
                      <i class="bi bi-eye me-1"></i>
                      View Details
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" [routerLink]="['/hr/jobs', job.id, 'edit']" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="openDeleteDialog(job.id!, $event)" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <i class="bi bi-inbox display-1"></i>
          <h4 class="mt-3">No jobs found</h4>
          <p class="text-muted">Try adjusting your filters or create a new job posting</p>
          <button class="btn btn-primary mt-3" routerLink="/hr/jobs/create">
            <i class="bi bi-plus-circle me-2"></i>
            Post New Job
          </button>
        </div>
      }
    }

    <!-- Jobs List View -->
    @if (viewMode() === 'list') {
      @if (filteredJobs().length > 0) {
        <div class="jobs-list">
          @for (job of filteredJobs(); track job.id) {
            <div class="job-list-item">
              <div class="row align-items-center g-3">
                <div class="col-lg-6">
                  <div class="d-flex gap-3">
                    <div class="company-logo-list">
                      <i class="bi bi-building"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="job-title-list mb-1">{{ job.title }}</h5>
                      <p class="company-name-list mb-2">
                        <i class="bi bi-building me-1"></i>
                        {{ job.companyName }}
                      </p>
                      <div class="d-flex flex-wrap gap-2">
                        <span class="badge" [ngClass]="getStatusBadgeClass(job.jobStatus)">
                          {{ job.jobStatus }}
                        </span>
                        @if (job.experienceLevel) {
                          <span class="badge" [ngClass]="getExperienceBadgeClass(job.experienceLevel)">
                            {{ formatExperienceLevel(job.experienceLevel) }}
                          </span>
                        }
                        @if (job.employmentType) {
                          <span class="badge badge-light">
                            <i class="bi me-1" [ngClass]="getEmploymentTypeIcon(job.employmentType)"></i>
                            {{ formatEmploymentType(job.employmentType) }}
                          </span>
                        }
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-3">
                  <div class="d-flex flex-column gap-2 small text-muted">
                    @if (job.location) {
                      <div>
                        <i class="bi bi-geo-alt me-1"></i>
                        {{ job.location }}
                      </div>
                    }
                    @if (job.salaryRange) {
                      <div>
                        <i class="bi bi-cash-stack me-1"></i>
                        {{ job.salaryRange }}
                      </div>
                    }
                    <div>
                      <i class="bi bi-people me-1"></i>
                      {{ job.totalApplications || 0 }} Applications
                    </div>
                  </div>
                </div>

                <div class="col-lg-3 text-lg-end">
                  <div class="d-flex flex-column gap-2">
                    @if (job.applicationDeadline) {
                      <small class="text-muted"
                             [class.text-danger]="isDeadlinePassed(job.applicationDeadline)"
                             [class.text-warning]="isDeadlineSoon(job.applicationDeadline)">
                        <i class="bi bi-calendar-event me-1"></i>
                        Deadline: {{ formatDate(job.applicationDeadline) }}
                      </small>
                    }
                    <div class="d-flex gap-2 justify-content-lg-end">
                      <button class="btn btn-sm btn-primary" [routerLink]="['/hr/jobs', job.id]">
                        <i class="bi bi-eye me-1"></i>
                        View
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" [routerLink]="['/hr/jobs', job.id, 'edit']" title="Edit">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" (click)="openDeleteDialog(job.id!, $event)" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <i class="bi bi-inbox display-1"></i>
          <h4 class="mt-3">No jobs found</h4>
          <p class="text-muted">Try adjusting your filters or create a new job posting</p>
          <button class="btn btn-primary mt-3" routerLink="/hr/jobs/create">
            <i class="bi bi-plus-circle me-2"></i>
            Post New Job
          </button>
        </div>
      }
    }
  </div>
}

<!-- Delete Confirmation Dialog -->
@if (showDeleteDialog()) {
  <div class="modal-overlay" (click)="closeDeleteDialog()">
    <div class="confirmation-dialog" (click)="$event.stopPropagation()">
      @if (!deleteSuccess()) {
        <div class="dialog-icon delete-icon">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h3 class="dialog-title">Delete Job Posting</h3>
        <p class="dialog-message">Are you sure you want to delete this job posting? This action cannot be undone.</p>
        
        @if (deleteMessage()) {
          <div class="alert alert-danger mt-3">
            {{ deleteMessage() }}
          </div>
        }
        
        <div class="dialog-actions">
          <button class="btn btn-secondary" (click)="closeDeleteDialog()" type="button">
            Cancel
          </button>
          <button class="btn btn-danger" (click)="confirmDelete()" type="button">
            <i class="bi bi-trash me-2"></i>
            Delete Job
          </button>
        </div>
      } @else {
        <div class="dialog-icon success-icon">
          <i class="bi bi-check-circle"></i>
        </div>
        <h3 class="dialog-title">Success!</h3>
        <p class="dialog-message">{{ deleteMessage() }}</p>
      }
    </div>
  </div>
}
